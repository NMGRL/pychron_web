{% extends 'base.html' %}
{% load static %}
{% block head %}
    <meta http-equiv="refresh" content="60">
{#    <link href="https://cdn.pydata.org/bokeh/release/bokeh-2.4.2.min.css" rel="stylesheet" type="text/css">#}
{#    <link href="https://cdn.pydata.org/bokeh/release/bokeh-widgets-2.4.2.min.css" rel="stylesheet" type="text/css">#}
    <script src="https://cdn.pydata.org/bokeh/release/bokeh-2.4.2.min.js"></script>
    <script src="https://cdn.pydata.org/bokeh/release/bokeh-widgets-2.4.2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>

{% endblock %}

{% block content %}
    <div>
    <h3 align="center"><div id="time">-</div></h3>
    </div>
    <p class="subtitle has-text-centered" id="progress-title"></p>
    <div class="row">
        <div class="col-sm-6">
            <div class="panel">
                <div id="cocktailsAr40"></div>
                <div id="cocktailsAr36"></div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="panel">
                <div id="airsAr40"></div>
                <div id="airsAr36"></div>
            </div>
        </div>
    </div>


{#    <div class="row">#}
{#        <div class="col-sm-4">#}
{#            {%  for group in ar40 %}#}
{#                {{ group.div | safe }}#}
{#            {% endfor %}#}
{#        </div>#}
{#        <div class="col-sm-4">#}
{#            {%  for group in ar36 %}#}
{#                {{ group.div | safe }}#}
{#            {% endfor %}#}
{#        </div>#}
{#        <div class="col-sm-4">#}
{#                {%  for ratio in ratios %}#}
{#                    {{ ratio.div | safe }}#}
{#                {% endfor %}#}
{#        </div>#}
{#    </div>#}

{#    <div class="row">#}
{#        <div class="col-md-4">#}
{#            <div class="panel panel-primary">#}
{#                <table class="table table-condensed">#}
{#                    {% for row in a.table %}#}
{#                        <tr>#}
{#                            {% for k in row %}#}
{#                                <td>{{ k }} </td>#}
{#                            {% endfor %}#}
{#                        </tr>#}
{#                    {% endfor %}#}
{#                </table>#}
{#            </div>#}
{#        </div>#}
{#        <div class="col-md-8">#}
{#            <div class="panel panel-primary">#}
{#                {% for s,d in a.figures %}#}
{#                {{ d | safe }}#}
{#            {% endfor %}#}
{#            </div>#}
{#        </div>#}
{#    </div>#}
{#    {% endfor %}#}



{#    <div class="row">#}
{#        <div class="col-sm-4">#}
{##}
{#        </div>#}
{##}
{#        <div class="col-sm-8">#}
{#        {% for a in analyses %}#}
{#            <h3>{{ a.runid }}</h3>#}
{#            {% for s,d in a.figures %}#}
{#                {{ d | safe }}#}
{#            {% endfor %}#}
{#        {% endfor %}#}
{#        </div>#}
{##}
{#    </div>#}

    <script>
    document.getElementById("time").textContent = "" + new Date().toLocaleString();
    </script>

    {% if task_id %}
  <script>
  var taskUrl = "{% url 'analyses:task' task_id=task_id %}";
  var dots = 1;
  var progressTitle = document.getElementById('progress-title');
  updateProgressTitle();
  var timer = setInterval(function() {
    updateProgressTitle();
    axios.get(taskUrl)
      .then(function(response){
        var taskStatus = response.data.task_status
        if (taskStatus === 'SUCCESS') {
          clearTimer('');
          {#var url = window.location.protocol + '//' + window.location.host + response.data.results.archive_path;#}
          {#var a = document.createElement("a");#}
          {#a.target = '_BLANK';#}
          {#document.body.appendChild(a);#}
          {#a.style = "display: none";#}
          {#a.href = url;#}
          {#a.download = 'results.zip';#}
          {#a.click();#}
          {#document.body.removeChild(a);#}
            window.Bokeh.embed.embed_item(JSON.parse(JSON.parse(response.data.results).cocktails.Ar40), 'cocktailsAr40')
            window.Bokeh.embed.embed_item(JSON.parse(JSON.parse(response.data.results).cocktails.Ar36), 'cocktailsAr36')
            window.Bokeh.embed.embed_item(JSON.parse(JSON.parse(response.data.results).airs.Ar40), 'airsAr40')
            window.Bokeh.embed.embed_item(JSON.parse(JSON.parse(response.data.results).airs.Ar36), 'airsAr36')

        } else if (taskStatus === 'FAILURE') {
          clearTimer('An error occurred');
        }
      })
      .catch(function(err){
        console.log('err', err);
        clearTimer('An error occurred');
      });
  }, 800);

  function updateProgressTitle() {
    dots++;
    if (dots > 3) {
      dots = 1;
    }
    progressTitle.innerHTML = 'Processing Analyses...';
    for (var i = 0; i < dots; i++) {
      progressTitle.innerHTML += '.';
    }
  }
  function clearTimer(message) {
    clearInterval(timer);
    progressTitle.innerHTML = message;
  }
  </script>
  {% endif %}

{% endblock %}